<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Panel Administracyjny</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 200px;
      height: 100vh;
      background: #eeeeee;
      padding: 20px;
      z-index: 100;
    }
    .submenu-panel {
      position: fixed;
      left: 200px;
      top: 0;
      width: 140px;
      height: 100vh;
      background: #f6f6f6;
      padding: 20px 8px;
      border-left: 1px solid #ddd;
      z-index: 101;
      display: none;
    }
    .submenu-panel.active {
      display: block;
    }
    .submenu-panel h3 {
      margin-top: 0;
      font-size: 1.1em;
      margin-bottom: 12px;
    }
    .submenu-panel a {
      display: block;
      margin-bottom: 10px;
      color: #007bff;
      text-decoration: none;
    }
    .submenu-panel a:hover {
      text-decoration: underline;
    }
    .app-container {
      transition: margin-left 0.2s;
      margin-left: 200px;
    }
    body.submenu-open .app-container {
      margin-left: 340px;
    }
    .main-content {
      padding: 20px;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <h2>MENU</h2>
      <ul>
        <li><a href="index.html">Pulpit</a></li>
        <li><a href="employees.html">Zespół</a></li>
        <li><span id="showSubmenu" style="cursor:pointer;font-weight:bold;">Obecność &#9654;</span></li>
        <li><a href="mobile_config.html">Konfiguracja Aplikacji</a></li>
      </ul>
    </aside>
    <div id="submenuPanel" class="submenu-panel">
      <h3>Obecność</h3>
      <a href="attendance_day.html">Obecność – Dzień</a>
      <a href="attendance_summary.html">Obecność – Ewidencja</a>
    </div>
    <main class="main-content" style="margin-left:200px;">
      <h1>Pulpit</h1>
      <div id="active-workers">Ładowanie danych...</div>
      <script>
      document.addEventListener('DOMContentLoaded', function() {
        try {
          console.log('Loading active workers...');
          
          // Użyj XMLHttpRequest zamiast fetch dla kompatybilności z Simple Browser
          const xhr = new XMLHttpRequest();
          xhr.open('GET', 'http://127.0.0.1:8002/active_workers', true);
          xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
              try {
                const data = JSON.parse(xhr.responseText);
                console.log('Received data:', data);
                
                const container = document.getElementById('active-workers');
                if (data.length === 0) {
                    container.innerHTML = "<p>Brak pracowników z dzisiaj.</p>";
                    return;
                }
                
                let html = "<table class='employee-table'><thead><tr><th></th><th>Imię i nazwisko</th><th>Start</th><th>Czas pracy</th><th>Lokalizacja wejścia</th></tr></thead><tbody>";
                data.forEach(worker => {
                    console.log('Processing worker:', worker);
                    const dot = `<span style='color:${worker.online ? 'green' : 'red'};font-size:1.5em;'>&#9679;</span>`;
                    let startLoc = '-';
                    if (worker.start_lat && worker.start_lon) {
                      try {
                        const lat = parseFloat(worker.start_lat).toFixed(5);
                        const lon = parseFloat(worker.start_lon).toFixed(5);
                        startLoc = `<a href='https://www.google.com/maps?q=${lat},${lon}' target='_blank'>Pokaż na mapie</a>`;
                      } catch (err) {
                        console.error('Error processing location:', err);
                        startLoc = 'Błąd lokalizacji';
                      }
                    }
                    html += `<tr>
                                <td style='text-align:center;'>${dot}</td>
                                <td>${worker.name}</td>
                                <td>${worker.start_time}</td>
                                <td>${worker.duration}</td>
                                <td>${startLoc}</td>
                             </tr>`;
                });
                html += "</tbody></table>";
                container.innerHTML = html;
                console.log('Table updated successfully');
                
              } catch (parseError) {
                console.error('Error parsing response:', parseError);
                document.getElementById('active-workers').innerHTML = "Błąd podczas parsowania danych.";
              }
            } else if (xhr.readyState === 4) {
              console.error('HTTP Error:', xhr.status);
              document.getElementById('active-workers').innerHTML = "Błąd podczas pobierania danych: " + xhr.status;
            }
          };
          xhr.send();
          
        } catch (error) {
          console.error("Szczegóły błędu:", error);
          document.getElementById('active-workers').innerHTML = "Błąd podczas pobierania danych: " + error.message;
        }
      }); // Zamknięcie DOMContentLoaded
      </script>
    </main>
  </div>
  <script>
    const showSubmenu = document.getElementById('showSubmenu');
    const submenuPanel = document.getElementById('submenuPanel');
    showSubmenu.onclick = function() {
      submenuPanel.classList.toggle('active');
      document.body.classList.toggle('submenu-open', submenuPanel.classList.contains('active'));
    };
    // Ukryj submenu po kliknięciu poza nim
    document.addEventListener('click', function(e) {
      if (!submenuPanel.contains(e.target) && e.target !== showSubmenu) {
        submenuPanel.classList.remove('active');
        document.body.classList.remove('submenu-open');
      }
    });
  </script>
</body>
</html>
