<!-- KOMPONENT: Obecność – Ewidencja (wyodrębniony z frontend/attendance_summary.html) -->
<div class="attendance-summary card">
  <div class="card-header">
    <h3 class="card-title">
      <i class="fas fa-chart-bar text-primary"></i>
      Obecność – Ewidencja
    </h3>
    <p class="card-subtitle">Szczegółowa ewidencja obecności wszystkich pracowników</p>
  </div>

  <div class="card-body">
    <form id="att-sum-form" class="mb-4">
      <div class="form-group">
        <label class="form-label"><i class="fas fa-calendar-alt"></i> Zakres dat:</label>
        <div class="form-row" style="display:flex; gap:.75rem; align-items:flex-end; flex-wrap:wrap;">
          <div class="form-group">
            <label for="att-from" class="form-label">Od:</label>
            <input type="date" id="att-from" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="att-to" class="form-label">Do:</label>
            <input type="date" id="att-to" class="form-control" required>
          </div>
          <div class="form-group" style="display:flex; gap:.5rem;">
            <button type="submit" id="att-show" class="btn btn-primary" title="Pokaż ewidencję">
              <i class="fas fa-search"></i>
              Pokaż ewidencję
            </button>
            <button type="button" id="att-this-month" class="btn btn-secondary" title="Ustaw bieżący miesiąc">
              <i class="fas fa-calendar"></i>
              Ten miesiąc
            </button>
          </div>
        </div>
      </div>
    </form>

    <div id="att-export" style="display:none; margin-bottom:12px;">
      <div class="form-row" style="display:flex; gap:.5rem; flex-wrap:wrap;">
        <button id="att-export-csv" class="btn btn-success"><i class="fas fa-file-excel"></i> Export CSV</button>
        <button id="att-export-pdf" class="btn btn-danger"><i class="fas fa-file-pdf"></i> Export do PDF</button>
        <button id="att-print" class="btn btn-info"><i class="fas fa-print"></i> Drukuj</button>
      </div>
    </div>

    <div id="att-sum-results">
      <div class="placeholder" style="padding: 16px; color:#6b7280;">
        <i class="fas fa-info-circle"></i>
        Wybierz zakres dat i kliknij „Pokaż ewidencję”.
      </div>
    </div>

    <div id="att-sum-add"></div>
  </div>
</div>

<style>
  .attendance-summary.card{ background: rgba(255,255,255,.95); border:1px solid #e9ecef; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.06); overflow:hidden; }
  .attendance-summary .card-header{ padding:18px 22px; border-bottom:1px solid #edf2f7; background:linear-gradient(180deg,#ffffff,#f9fbff); }
  .attendance-summary .card-title{ margin:0; font-size:18px; font-weight:800; color:#2c3e50; display:flex; align-items:center; gap:8px; }
  .attendance-summary .card-subtitle{ margin:.25rem 0 0; color:#64748b; }
  .attendance-summary .card-body{ padding:18px 22px; }
  .attendance-summary .btn{ display:inline-flex; align-items:center; gap:.45rem; padding:.5rem .75rem; border-radius:10px; border:1px solid transparent; font-weight:600; cursor:pointer; transition: transform .12s ease, box-shadow .2s ease, background .2s ease; }
  .attendance-summary .btn:hover{ transform: translateY(-1px); box-shadow:0 8px 20px rgba(0,0,0,.08); }
  .attendance-summary .btn-primary{ background:#2563eb; border-color:#2563eb; color:#fff; }
  .attendance-summary .btn-secondary{ background:#64748b; border-color:#64748b; color:#fff; }
  .attendance-summary .btn-success{ background:#16a34a; border-color:#16a34a; color:#fff; }
  .attendance-summary .btn-info{ background:#0ea5e9; border-color:#0ea5e9; color:#fff; }
  .attendance-summary .btn-danger{ background:#dc2626; border-color:#dc2626; color:#fff; }
  .attendance-summary .table{ width:100%; border-collapse: collapse; }
  .attendance-summary .table th, .attendance-summary .table td{ padding:10px 12px; border-bottom:1px solid #eef2f7; vertical-align: middle; }
  .attendance-summary .table thead th{ background:#f8fafc; font-weight:700; color:#334155; position:sticky; top:0; z-index:1; }
  .attendance-summary .text-muted{ color:#94a3b8; }
  .attendance-summary .text-danger{ color:#dc2626; }
  .attendance-summary .text-success{ color:#16a34a; }
  .attendance-summary .text-primary{ color:#2563eb; }
  .attendance-summary .badge{ display:inline-block; padding:.35em .6em; font-size:.8rem; font-weight:700; line-height:1; color:#111827; background:#eef2ff; border-radius:.5rem; }
  .attendance-summary .days-grid{ display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 8px; }
  .attendance-summary .day-chip{ display:flex; align-items:center; gap:.5rem; padding:8px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; }
  .attendance-summary .badge-warning{ background:#fef3c7; color:#92400e; }
  .attendance-summary .badge-danger{ background:#fee2e2; color:#991b1b; }
  .attendance-summary .badge-primary{ background:#e0e7ff; color:#1e40af; }
</style>

<script>
(function(){
  const state = { bound:false, lastRange:null, data:[] };

  function qs(id){ return document.getElementById(id); }
  function getApiUrl(endpoint){ if(!endpoint.startsWith('/api/')) endpoint = '/api' + endpoint; return endpoint; }
  function todayStr(){ const d = new Date(); const off = d.getTimezoneOffset(); return new Date(d - off*60000).toISOString().slice(0,10); }
  function thisMonth(){
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), 1);
    const end = new Date(now.getFullYear(), now.getMonth()+1, 0);
    const off = start.getTimezoneOffset();
    const s = new Date(start - off*60000).toISOString().slice(0,10);
    const e = new Date(end - off*60000).toISOString().slice(0,10);
    return { start:s, end:e };
  }
  function getDaysArray(start, end){
    const arr = []; let dt = new Date(start + 'T00:00:00'); const dtEnd = new Date(end + 'T00:00:00');
    while(dt <= dtEnd){ arr.push(dt.toISOString().slice(0,10)); dt.setDate(dt.getDate()+1); }
    return arr;
  }
  function weekdayInfo(iso){ const wd = new Date(iso+'T00:00:00').getDay(); const names=['niedziela','poniedziałek','wtorek','środa','czwartek','piątek','sobota']; return { wd, name:names[wd] }; }

  function attachExportHandlers(){
    const panel = qs('att-export');
    const tbl = ()=> document.querySelector('#att-sum-results table');
    const toCSV = ()=>{
      const table = tbl(); if(!table){ alert('Brak danych do eksportu!'); return; }
      const rows = Array.from(table.rows);
      let csv = '';
      if(rows.length){
        csv += Array.from(rows[0].cells).map(c => '"'+c.innerText.replace(/"/g,'""')+'"').join(',') + '\n';
        for(let i=1;i<rows.length;i++) csv += Array.from(rows[i].cells).map(c => '"'+c.innerText.replace(/"/g,'""')+'"').join(',') + '\n';
      }
      const blob = new Blob(["\uFEFF"+csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='ewidencja_obecnosci.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    };
    const toPDF = ()=> window.print();
    qs('att-export-csv')?.addEventListener('click', (e)=>{ e.preventDefault(); toCSV(); });
    qs('att-export-pdf')?.addEventListener('click', (e)=>{ e.preventDefault(); toPDF(); });
    qs('att-print')?.addEventListener('click', (e)=>{ e.preventDefault(); window.print(); });
    if(panel) panel.style.display = 'block';
  }

  function renderAddSection(from, to){
    const add = qs('att-sum-add'); if(!add) return;
    add.innerHTML = `
      <div class="card mt-4">
        <div class="card-header">
          <h4 class="card-title"><i class=\"fas fa-user-plus text-info\"></i> Dodaj pracownika do ewidencji</h4>
        </div>
        <div class="card-body">
          <button id='att-add-open' class="btn btn-info"><i class=\"fas fa-plus\"></i> Dodaj pracownika do ewidencji</button>
          <div id='att-add-form' style="margin-top:12px;"></div>
        </div>
      </div>`;

    qs('att-add-open')?.addEventListener('click', ()=> showAddEmployeeForm(from, to));
  }

  async function showAddEmployeeForm(from, to){
    const cont = qs('att-add-form'); if(!cont) return;
    cont.innerHTML = '<p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Ładowanie...</p>';
    try{
      const url = getApiUrl(`/employees_without_logs?date_from=${encodeURIComponent(from)}&date_to=${encodeURIComponent(to)}`);
      const res = await fetch(url, { credentials:'include' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      if(!Array.isArray(data) || !data.length){ cont.innerHTML = '<p class="text-muted mt-2">Brak pracowników bez logów w tym okresie.</p>'; return; }
      cont.innerHTML = `
        <form id='att-add-form-inner' class="form">
          <div class="form-group">
            <label for="att-emp" class="form-label">Pracownik:</label>
            <select id='att-emp' class="form-control" required>
              <option value=''>--wybierz pracownika--</option>
              ${data.map(emp => `<option value='${emp.id}'>${emp.name || emp.first_name+" "+(emp.last_name||'')}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Wybierz dni pracy:</label>
            <div class="days-grid">
              ${getDaysArray(from,to).map(d=>{
                const info = weekdayInfo(d);
                let badgeClass = 'badge-primary';
                if(info.wd===6) badgeClass='badge-warning';
                if(info.wd===0) badgeClass='badge-danger';
                return `<label class=\"day-chip\"><input type=\"checkbox\" name=\"days\" value=\"${d}\" style=\"margin-right:8px;\"><div><div><strong>${d}</strong></div><span class=\"badge ${badgeClass}\">${info.name}</span></div></label>`;
              }).join('')}
            </div>
          </div>
          <div class="form-actions" style="margin-top:10px; display:flex; gap:.5rem;">
            <button type='submit' class="btn btn-success"><i class="fas fa-check"></i> Dodaj dni pracy</button>
            <button type='button' id='att-add-cancel' class="btn btn-secondary"><i class="fas fa-times"></i> Anuluj</button>
          </div>
        </form>`;

      qs('att-add-cancel')?.addEventListener('click', ()=> cont.innerHTML='');
      qs('att-add-form-inner')?.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const empId = qs('att-emp')?.value;
        const days = Array.from(document.querySelectorAll('input[name="days"]:checked')).map(x=>x.value);
        if(!empId || days.length===0){ alert('Wybierz pracownika i co najmniej jeden dzień!'); return; }
        const logs = days.map(d => ({ employee_id: empId, date: d }));
        try{
          const r = await fetch(getApiUrl('/logs/batch'), { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(logs) });
          if(!r.ok) throw new Error('HTTP '+r.status);
          alert('Dodano dni pracy!');
          cont.innerHTML = '';
          // odśwież ostatni zakres, jeżeli istnieje
          if(state.lastRange){ await load(state.lastRange.start, state.lastRange.end); }
        }catch(err){ alert('Błąd podczas dodawania dni pracy: '+err.message); }
      });
    }catch(err){ cont.innerHTML = '<p class="text-danger mt-2">Błąd podczas pobierania listy pracowników.</p>'; console.error(err); }
  }

  function renderSummary(data, from, to){
    const container = qs('att-sum-results'); if(!container) return;
    if(!Array.isArray(data) || data.length===0){
      container.innerHTML = `
        <div class="card"><div class="card-body" style="padding:16px; text-align:center;">
          <i class=\"fas fa-calendar-times text-muted\" style=\"font-size: 2.2rem;\"></i>
          <h3 class=\"mt-3 text-muted\" style=\"margin:.5rem 0 0;\">Brak danych</h3>
          <p class=\"text-muted\" style=\"margin:.25rem 0;\">Brak danych dla wybranego zakresu dat.</p>
        </div></div>`;
      qs('att-export').style.display = 'none';
      qs('att-sum-add').innerHTML = '';
      return;
    }
    let totalAmount = 0;
    let html = `
      <div class="card">
        <div class="card-header">
          <h3 class="card-title"><i class=\"fas fa-chart-line text-success\"></i> Ewidencja czasu pracy</h3>
          <p class="card-subtitle">Okres: ${from} - ${to} (${data.length} pracowników)</p>
        </div>
        <div class="card-body">
          <table class="table">
            <thead>
              <tr>
                <th>Pracownik</th>
                <th>Dni obecności</th>
                <th>Łączny czas</th>
                <th>Soboty</th>
                <th>Niedziele</th>
                <th>Święta</th>
                <th>Kwota</th>
              </tr>
            </thead>
            <tbody>`;
    for(const item of data){
      const name = item.name || [item.first_name,item.last_name].filter(Boolean).join(' ') || '(nieznany)';
      const totalHours = Number(item.total_hours ?? item.totalHours ?? 0) || 0;
      const rate = Number(item.rate ?? item.hourly_rate ?? 0) || 0;
      const amount = totalHours*rate;
      totalAmount += amount;
      const amountStr = amount>0? amount.toFixed(2)+' zł' : '-';
      const daysPresent = item.days_present ?? item.daysPresent ?? '-';
      const totalTimeStr = item.total_time ?? item.totalTime ?? '-';
      const saturdays = item.saturdays ?? 0;
      const sundays = item.sundays ?? 0;
      const holidays = item.holidays ?? 0;
      const id = item.id ?? item.employee_id ?? '';
      html += `
        <tr>
          <td>
            <a href="/frontend/employee-details-test.html?worker_id=${encodeURIComponent(id)}&start=${encodeURIComponent(from)}&end=${encodeURIComponent(to)}" target="_blank" class="btn btn-sm btn-primary" title="Szczegóły pracownika">
              <i class=\"fas fa-user\"></i> ${name}
            </a>
          </td>
          <td><span class=\"badge\">${daysPresent}</span></td>
          <td><i class=\"fas fa-clock text-primary\"></i> <strong>${totalTimeStr}</strong></td>
          <td><span class=\"badge badge-warning\">${saturdays}</span></td>
          <td><span class=\"badge badge-danger\">${sundays}</span></td>
          <td><span class=\"badge\">${holidays}</span></td>
          <td><strong class=\"text-success\">${amountStr}</strong></td>
        </tr>`;
    }
    html += `</tbody><tfoot><tr class=\"table-info\"><th>RAZEM</th><th>-</th><th>-</th><th>-</th><th>-</th><th>-</th><th><strong class=\"text-success\">${totalAmount.toFixed(2)} zł</strong></th></tr></tfoot></table></div></div>`;
    container.innerHTML = html;
    attachExportHandlers();
    renderAddSection(from, to);
  }

  async function load(from, to){
    const container = qs('att-sum-results');
    if(!from || !to){ alert('Wybierz zakres dat!'); return; }
    state.lastRange = { start: from, end: to };
    if(container){
      container.innerHTML = `<div style=\"padding: 24px; text-align:center; color:#6c757d;\"><i class=\"fas fa-spinner fa-spin text-primary\" style=\"font-size:1.5rem;\"></i><div style=\"margin-top:.5rem;\">Ładowanie ewidencji...</div></div>`;
    }
    try{
      const url = getApiUrl(`/attendance_summary?date_from=${encodeURIComponent(from)}&date_to=${encodeURIComponent(to)}`);
      const res = await fetch(url, { credentials:'include' });
      if(!res.ok){ const t = await res.text().catch(()=> ''); throw new Error(t || ('HTTP '+res.status)); }
      const data = await res.json();
      state.data = Array.isArray(data)? data: [];
      renderSummary(state.data, from, to);
    }catch(err){
      if(container){
        container.innerHTML = `
          <div class=\"card\"><div class=\"card-body\" style=\"padding:16px; text-align:center;\">
            <i class=\"fas fa-exclamation-triangle text-danger\" style=\"font-size: 2.2rem;\"></i>
            <h3 class=\"mt-3 text-danger\" style=\"margin:.5rem 0 0;\">Błąd połączenia</h3>
            <p class=\"text-muted\">Nie udało się pobrać ewidencji obecności.</p>
            <button class=\"btn btn-primary\" id=\"att-retry\"><i class=\"fas fa-rotate\"></i> Spróbuj ponownie</button>
          </div></div>`;
        qs('att-retry')?.addEventListener('click', ()=> load(from,to));
      }
      console.error(err);
      qs('att-export').style.display = 'none';
      qs('att-sum-add').innerHTML = '';
    }
  }

  function bindOnce(){
    if(state.bound) return; state.bound = true;
    const form = qs('att-sum-form');
    const btn = qs('att-show');
    const thisMonthBtn = qs('att-this-month');
    form?.addEventListener('submit', (e)=>{ e.preventDefault(); const f=qs('att-from').value; const t=qs('att-to').value; load(f,t); });
    btn?.addEventListener('click', (e)=>{ /* handled by form submit */ });
    thisMonthBtn?.addEventListener('click', ()=>{ const r=thisMonth(); qs('att-from').value=r.start; qs('att-to').value=r.end; });

    // domyślnie wypełnij bieżący miesiąc
    const r=thisMonth(); if(qs('att-from') && qs('att-to')){ if(!qs('att-from').value) qs('att-from').value=r.start; if(!qs('att-to').value) qs('att-to').value=r.end; }
  }

  function init(){ bindOnce(); }

  window.AttendanceSummaryComponent = { init, load };
})();
</script>
