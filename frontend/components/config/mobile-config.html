<!-- KOMPONENT: Konfiguracja Aplikacji Mobilnej -->
<div id="mobile-config-component" class="mobile-config card">
  <div class="card-header">
    <h3 class="card-title">
      <i class="fas fa-cog text-primary"></i>
      Konfiguracja Aplikacji
    </h3>
    <p class="card-subtitle">Zarządzaj funkcjami aplikacji mobilnej dla pracowników</p>
  </div>

  <div class="card-body">
    <div class="mc-top" style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
      <small style="background:#f8f9fa; padding:6px 10px; border-radius:8px; color:#666;">
        <i class="fas fa-code-branch"></i> Wersja konfiguracji: <span id="mc-configVersion">Ładowanie...</span>
      </small>
      <small style="background:#f8f9fa; padding:6px 10px; border-radius:8px; color:#666;">
        <i class="fas fa-clock"></i> Ostatnia aktualizacja: <span id="mc-lastUpdate">Ładowanie...</span>
      </small>
      <small style="background:#f8f9fa; padding:6px 10px; border-radius:8px; color:#666;">
        <i class="fas fa-server"></i> Status serwera: <span id="mc-serverStatus">Sprawdzanie...</span>
      </small>
      <div style="margin-left:auto; display:flex; gap:.5rem;"></div>
    </div>

    <div id="mc-status" class="mc-status" aria-live="polite" style="margin:10px 0;"></div>

    <div class="mc-section">
      <h4><i class="fas fa-clock"></i> Funkcje Czasowe</h4>
      <div class="mc-row">
        <div class="mc-label">Timer pracy</div>
        <div class="mc-desc">Wyświetla licznik czasu od rozpoczęcia pracy</div>
        <div class="toggle-container">
          <label class="toggle-switch">
            <input type="checkbox" id="timer_enabled">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      <div class="mc-row">
        <div class="mc-label">Statystyki dzienne</div>
        <div class="mc-desc">Pokazuje statystyki pracy w aplikacji</div>
        <div class="toggle-container">
          <label class="toggle-switch">
            <input type="checkbox" id="daily_stats">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      <div class="mc-row">
        <div class="mc-label">Statystyki miesięczne</div>
        <div class="mc-desc">Wyświetla podsumowanie miesięczne</div>
        <div class="toggle-container">
          <label class="toggle-switch">
            <input type="checkbox" id="monthly_stats">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
    </div>

    <div class="mc-section">
      <h4><i class="fas fa-shield-alt"></i> Bezpieczeństwo</h4>
      <div class="mc-row">
        <div class="mc-label">Blokada pól podczas pracy</div>
        <div class="mc-desc">Zablokuj edycję numeru pracownika podczas trwającej pracy</div>
        <div class="toggle-container">
          <label class="toggle-switch">
            <input type="checkbox" id="field_blocking">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      <div class="mc-row">
        <div class="mc-label">Weryfikacja GPS</div>
        <div class="mc-desc">Wymagaj aktywnej lokalizacji do rejestracji</div>
        <div class="toggle-container">
          <label class="toggle-switch">
            <input type="checkbox" id="gps_verification">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
    </div>

    <div class="mc-section">
      <h4><i class="fas fa-desktop"></i> Interfejs</h4>
      <div class="mc-row">
        <div class="mc-label">Widget na pulpit</div>
        <div class="mc-desc">Umożliwia dodanie widgetu na ekran główny telefonu</div>
        <div class="toggle-container">
          <label class="toggle-switch">
            <input type="checkbox" id="widget_support">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      <div class="mc-row">
        <div class="mc-label">Powiadomienia</div>
        <div class="mc-desc">Wysyłaj powiadomienia o ważnych wydarzeniach</div>
        <div class="toggle-container">
          <label class="toggle-switch">
            <input type="checkbox" id="notifications">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      <div class="mc-row">
        <div class="mc-label">Tryb offline</div>
        <div class="mc-desc">Zezwalaj na pracę bez połączenia internetowego</div>
        <div class="toggle-container">
          <label class="toggle-switch">
            <input type="checkbox" id="offline_mode">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
    </div>

    <div class="mc-section">
      <h4><i class="fas fa-cogs"></i> Zaawansowane</h4>
      <div class="mc-row">
        <div class="mc-label">Debug mode</div>
        <div class="mc-desc">Pokazuje dodatkowe informacje techniczne</div>
        <div class="toggle-container">
          <label class="toggle-switch">
            <input type="checkbox" id="debug_mode">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      <div class="mc-row">
        <div class="mc-label">Auto-aktualizacje</div>
        <div class="mc-desc">Automatyczne sprawdzanie i powiadomienia o aktualizacjach</div>
        <div class="toggle-container">
          <label class="toggle-switch">
            <input type="checkbox" id="auto_updates">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
    </div>

    <div class="mc-section">
      <h4><i class="fas fa-mobile-alt"></i> Zarządzanie Aktualizacjami</h4>
      <div class="card" style="margin-bottom:12px;">
        <div class="card-body">
          <div style="display:grid; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); gap:10px;">
            <div><strong>Aktualna wersja w sklepie:</strong> <span id="mc-currentPlayStoreVersion">Ładowanie...</span></div>
            <div><strong>Minimalna wymagana wersja:</strong> <span id="mc-minimumVersion">Ładowanie...</span></div>
          </div>
          <div class="form-group" style="margin-top:10px;">
            <label class="form-label" for="mc-playStoreUrl">URL do Play Store:</label>
            <input type="text" id="mc-playStoreUrl" class="form-control" placeholder="https://play.google.com/store/apps/details?id=..." />
          </div>
          <div class="form-group" style="margin-top:10px;">
            <label class="form-label" for="mc-updateMessage">Komunikat o aktualizacji:</label>
            <textarea id="mc-updateMessage" class="form-control" rows="3" placeholder="Dostępna nowa wersja aplikacji..."></textarea>
          </div>
          <div class="form-group" style="margin-top:10px; display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="mc-forceUpdate" />
            <label for="mc-forceUpdate">Wymuś aktualizację (aplikacja nie będzie działać bez aktualizacji)</label>
          </div>
          <div style="margin-top:10px; display:flex; gap:.5rem;">
            <button id="mc-save-version" class="btn btn-warning"><i class="fas fa-save"></i> Zapisz ustawienia wersji</button>
          </div>
        </div>
      </div>
    </div>

    <div style="display:flex; gap:.5rem;">
      <button id="mc-save" class="btn btn-primary"><i class="fas fa-save"></i> Zapisz Konfigurację</button>
      <button id="mc-reload" class="btn btn-secondary"><i class="fas fa-rotate"></i> Odśwież</button>
    </div>
  </div>
</div>

<style>
  .mobile-config.card{ background: rgba(255,255,255,.95); border:1px solid #e9ecef; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.06); overflow:hidden; }
  .mobile-config .card-header{ padding:18px 22px; border-bottom:1px solid #edf2f7; background:linear-gradient(180deg,#ffffff,#f9fbff); }
  .mobile-config .card-title{ margin:0; font-size:18px; font-weight:800; color:#2c3e50; display:flex; align-items:center; gap:8px; }
  .mobile-config .card-subtitle{ margin:.25rem 0 0; color:#64748b; }
  .mobile-config .card-body{ padding:18px 22px; }
  .mobile-config .btn{ display:inline-flex; align-items:center; gap:.45rem; padding:.5rem .75rem; border-radius:10px; border:1px solid transparent; font-weight:600; cursor:pointer; transition: transform .12s ease, box-shadow .2s ease, background .2s ease; }
  .mobile-config .btn:hover{ transform: translateY(-1px); box-shadow:0 8px 20px rgba(0,0,0,.08); }
  .mobile-config .btn-primary{ background:#2563eb; border-color:#2563eb; color:#fff; }
  .mobile-config .btn-secondary{ background:#64748b; border-color:#64748b; color:#fff; }
  .mobile-config .btn-warning{ background:#f59e0b; border-color:#f59e0b; color:#fff; }
  .mobile-config .mc-section{ background:#fff; border:1px solid #e9ecef; border-radius:14px; padding:12px 14px; margin:12px 0; }
  .mobile-config .mc-row{ display:flex; align-items:center; gap:12px; padding:10px 0; border-bottom:1px solid #f1f5f9; flex-wrap:wrap; }
  .mobile-config .mc-row:last-child{ border-bottom:none; }
  .mobile-config .mc-label{ min-width: 200px; font-weight:700; color:#334155; }
  .mobile-config .mc-desc{ color:#64748b; font-size:.95rem; min-width:240px; max-width:420px; }
  .mobile-config .mc-status{ min-height: 24px; font-size:.95rem; }

  /* Toggle */
  .mobile-config .toggle-container{ width:60px; height:30px; display:flex; align-items:center; justify-content:center; }
  .mobile-config .toggle-switch{ position:relative; width:50px; height:26px; }
  .mobile-config .toggle-switch input{ opacity:0; width:0; height:0; }
  .mobile-config .toggle-slider{ position:absolute; inset:0; background:#cbd5e1; border-radius:999px; transition:.25s; }
  .mobile-config .toggle-slider:before{ content:''; position:absolute; left:3px; top:3px; width:20px; height:20px; background:#fff; border-radius:999px; box-shadow:0 2px 6px rgba(0,0,0,.2); transition:.25s; }
  .mobile-config .toggle-switch input:checked + .toggle-slider{ background:#16a34a; }
  .mobile-config .toggle-switch input:checked + .toggle-slider:before{ transform: translateX(24px); }

  @media (max-width:768px){
    .mobile-config .mc-row{ flex-direction:column; align-items:flex-start; }
    .mobile-config .mc-label{ min-width:unset; }
    .mobile-config .mc-desc{ max-width:unset; }
  }

  .mobile-config .text-ok{ color:#16a34a; }
  .mobile-config .text-err{ color:#dc2626; }
</style>

<script>
(function(){
  const state = { bound:false, config:{} };
  const root = document.getElementById('mobile-config-component');
  const qs = (sel)=> root.querySelector(sel);
  function api(endpoint){ if(!endpoint.startsWith('/api/')) endpoint = '/api' + endpoint; return endpoint; }

  function msg(text, ok){ const el=qs('#mc-status'); if(!el) return; el.innerHTML = text? `<span class="${ok? 'text-ok':'text-err'}">${text}</span>` : ''; }

  function collectConfig(){
    const cfg = {};
    root.querySelectorAll('input[type="checkbox"]').forEach(cb =>{
      if(cb.id && !cb.id.startsWith('mc-')) cfg[cb.id] = cb.checked;
    });
    return cfg;
  }

  async function loadConfig(){
    msg('<i class="fas fa-spinner fa-spin"></i> Ładowanie...', true);
    try{
      const res = await fetch(api('/mobile-config'), { credentials:'include' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      const cfg = data?.config || data?.MOBILE_APP_CONFIG || {};
      state.config = cfg;
      // ustaw checkboksy
      Object.keys(cfg).forEach(k => { const el = qs('#'+k); if(el) el.checked = cfg[k]===true; });
      qs('#mc-configVersion').textContent = data.config_version || data.version || 'Nieznana';
      qs('#mc-lastUpdate').textContent = data.timestamp ? new Date(data.timestamp).toLocaleString('pl-PL') : 'Brak danych';
      qs('#mc-serverStatus').textContent = 'Połączony'; qs('#mc-serverStatus').className='text-ok';
      await loadVersionInfo();
      msg('Załadowano konfigurację.', true);
    }catch(err){
      qs('#mc-serverStatus').textContent = 'Błąd'; qs('#mc-serverStatus').className='text-err';
      msg('Błąd ładowania: '+err.message, false);
    }
  }

  async function loadVersionInfo(){
    try{
      const res = await fetch(api('/app-version'), { credentials:'include' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json(); const v = data.version_info || data;
      qs('#mc-currentPlayStoreVersion').textContent = v.current_version ?? '-';
      qs('#mc-minimumVersion').textContent = v.minimum_version ?? '-';
      qs('#mc-playStoreUrl').value = v.play_store_url ?? '';
      qs('#mc-updateMessage').value = v.update_message ?? '';
      qs('#mc-forceUpdate').checked = !!(v.update_required);
    }catch(err){ console.warn('Version info:', err.message); }
  }

  async function saveConfig(){
    const btn = qs('#mc-save'); btn.disabled = true; const original = btn.innerHTML; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Zapisywanie...';
    try{
      const payload = { MOBILE_APP_CONFIG: collectConfig() };
      const res = await fetch(api('/mobile-config'), { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(payload) });
      if(!res.ok){ const t = await res.text().catch(()=> ''); throw new Error(t || ('HTTP '+res.status)); }
      const j = await res.json().catch(()=> ({}));
      const newVersion = j.config_version || j.new_version || j.version || 'Nieznana';
      qs('#mc-configVersion').textContent = newVersion;
      msg('Zapisano konfigurację. Nowa wersja: '+newVersion, true);
      await loadConfig();
    }catch(err){ msg('Błąd zapisu: '+err.message, false); }
    finally{ btn.disabled = false; btn.innerHTML = original; }
  }

  async function saveVersion(){
    const btn = qs('#mc-save-version'); btn.disabled = true; const original = btn.innerHTML; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Zapisywanie...';
    const payload = {
      current_version: qs('#mc-currentPlayStoreVersion').textContent,
      minimum_version: qs('#mc-minimumVersion').textContent,
      play_store_url: qs('#mc-playStoreUrl').value,
      update_message: qs('#mc-updateMessage').value,
      update_required: qs('#mc-forceUpdate').checked
    };
    try{
      const res = await fetch(api('/app-version'), { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ version_info: payload }) });
      if(!res.ok) throw new Error('HTTP '+res.status);
      msg('Ustawienia wersji zapisane.', true);
    }catch(err){ msg('Nie udało się zapisać ustawień wersji: '+err.message, false); }
    finally{ btn.disabled=false; btn.innerHTML = original; }
  }

  function bindOnce(){
    if(state.bound) return; state.bound = true;
    qs('#mc-save')?.addEventListener('click', saveConfig);
    qs('#mc-reload')?.addEventListener('click', loadConfig);
    qs('#mc-save-version')?.addEventListener('click', saveVersion);
  }

  function init(){ bindOnce(); loadConfig(); }

  window.MobileConfigComponent = { init, reload: loadConfig };
})();
</script>
